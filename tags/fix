resource "local_file" "standard_tags_json" {
  filename = "${path.module}/standard_tags.json"
  content = jsonencode({
    tags_to_be_added           = local.tags_to_be_added
    sql_warehouse_desired_tags = local.sql_warehouse_desired_tags
    databricks_compute_tags    = local.databricks_compute_tags
  })
}

resource "local_file" "resource_tags_json" {
  for_each = local.tags_to_be_added
  filename = "${path.module}/tags_${replace(each.key, "/", "_")}.json"
  content  = jsonencode(each.value)
}

resource "local_file" "azure_tag_script" {
  filename = "${path.module}/tag_azure_resource.ps1"
  content = <<-PS1
  [CmdletBinding()]
  param(
    [Parameter(Mandatory)][string]$Rid,
    [Parameter(Mandatory)][string]$TagsFile,
    [Parameter(Mandatory)][int]$SleepSeconds
  )

  $ErrorActionPreference = "Stop"

  Write-Host "Script path:" $PSCommandPath
  Write-Host "Working dir:" (Get-Location).Path
  Write-Host "Rid:" $Rid
  Write-Host "TagsFile:" $TagsFile

  if (-not (Test-Path -LiteralPath $TagsFile)) {
    throw "Tags file not found: $TagsFile"
  }

  $tagsMap = Get-Content -LiteralPath $TagsFile -Raw | ConvertFrom-Json

  $tags = @()
  foreach ($prop in $tagsMap.PSObject.Properties) {
    $val = [string]$prop.Value
    $val = $val -replace "`r|`n", " "
    $tags += ("{0}={1}" -f $prop.Name, $val)
  }

  Write-Host "Tagging Azure resource: $Rid"
  az resource tag --ids $Rid --tags $tags | Out-Host

  Start-Sleep -Seconds $SleepSeconds
  PS1
}

resource "null_resource" "add_tags" {
  for_each = local.tags_to_be_added

  triggers = {
    resource_id = each.key
    tags_hash   = sha1(jsonencode(each.value))
  }

  provisioner "local-exec" {
    on_failure = "fail"

    # IMPORTANT: Use ABSOLUTE paths (no ..\ or .\)
    command = "pwsh -NoProfile -ExecutionPolicy Bypass -File \"${path.module}\\tag_azure_resource.ps1\" -Rid \"${each.key}\" -TagsFile \"${path.module}\\tags_${replace(each.key, "/", "_")}.json\" -SleepSeconds ${var.adh_standard_tags_update_delay_in_seconds}"
  }

  depends_on = [
    local_file.azure_tag_script,
    local_file.resource_tags_json
  ]
}

resource "null_resource" "sql_warehouse_tags" {
  triggers = {
    tags_hash = sha1(jsonencode(local.sql_warehouse_desired_tags))
  }

  provisioner "local-exec" {
    on_failure = "fail"
    command    = "pwsh -NoProfile -ExecutionPolicy Bypass -File \"${path.module}\\tag_sql_warehouse.ps1\""
  }

  depends_on = [
    local_file.standard_tags_json,
    null_resource.add_tags
  ]
}

resource "null_resource" "compute_tags" {
  triggers = {
    tags_hash = sha1(jsonencode(local.databricks_compute_tags))
    mode      = var.databricks_compute_tags_use_json_file_as_source_of_truth
  }

  provisioner "local-exec" {
    on_failure = "fail"

    command = var.databricks_compute_tags_use_json_file_as_source_of_truth == "true"
      ? "pwsh -NoProfile -ExecutionPolicy Bypass -File \"${path.module}\\tag_compute.ps1\" -run_idempotent:$true"
      : "pwsh -NoProfile -ExecutionPolicy Bypass -File \"${path.module}\\tag_compute.ps1\" -run_idempotent:$false"
  }

  depends_on = [
    local_file.standard_tags_json,
    null_resource.add_tags
  ]
}
