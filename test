[CmdletBinding()]
param(
    [Parameter(Mandatory)][string]$TenantId,
    [Parameter(Mandatory)][string]$ClientId,
    [Parameter(Mandatory)][string]$ClientSecret,
    [Parameter(Mandatory)][string]$adh_group,
    [string]$adh_sub_group = '',
    [ValidateSet('nonprd','prd')][string]$adh_subscription_type = 'nonprd',
    [Parameter(Mandatory)][string]$OutputDir,
    [string]$BranchName = ''
)

# -------------------------------------------------------
# Imports
# -------------------------------------------------------
Import-Module Az.Accounts, Az.Resources, Az.Databricks, Az.KeyVault -ErrorAction Stop
Import-Module (Join-Path $PSScriptRoot 'Common.psm1') -Force -ErrorAction Stop
Import-Module (Join-Path $PSScriptRoot 'DatabricksHelper.psm1') -Force -ErrorAction Stop

# -------------------------------------------------------
# Prep
# -------------------------------------------------------
$OutputDir = Ensure-Dir -Path $OutputDir

# Login with pipeline SPN (used only to talk to Azure / KV)
if (-not (Connect-ScAz -TenantId $TenantId -ClientId $ClientId -ClientSecret $ClientSecret)) {
    throw "Azure connection failed."
}

# Build Custodian
# - If adh_sub_group is null/empty -> Custodian = adh_group
# - Else                        -> Custodian = adh_group_adh_sub_group
$Custodian = if ([string]::IsNullOrWhiteSpace($adh_sub_group)) {
    $adh_group
} else {
    "${adh_group}_${adh_sub_group}"
}

# Environments
$envsToCheck = if ($adh_subscription_type -eq 'prd') { @('prd') } else { @('dev', 'tst', 'stg') }

# Subscriptions to scan (your helper)
$subs = Resolve-DbSubscriptions -AdhGroup $adh_group -Environment $adh_subscription_type

# -------------------------------------------------------
# Results
# -------------------------------------------------------
$workspaceResults     = @()
$workspacePermResults = @()
$sqlWhResults         = @()
$sqlWhPermResults     = @()
$catalogListResults   = @()
$catalogPermResults   = @()
$extLocResults        = @()
$extLocPermResults    = @()

# -------------------------------------------------------
# Main Loop
# -------------------------------------------------------
foreach ($sub in $subs) {

    Set-ScContext -Subscription $sub

    foreach ($env in $envsToCheck) {

        # Key Vaults
        $keyVaultNameInfra = "ADH-$Custodian-Infra-KV-$env"  # PAT + workspace URL/ID
        $keyVaultNameCust  = "ADH-$Custodian-KV-$env"        # Gen_SPN client ID + secret

        $DatabricksPat        = $null
        $workspaceUrl         = $null
        $workspaceId          = $null
        $DbSpnClientId        = $null
        $DbSpnClientSecret    = $null

        # ---------------------------------------------------
        # 0. Gen_SPN client ID & secret from ADH-<Custodian>-KV-<env>
        #    Secret names:
        #       ADH_<Custodian>_Gen_SPN_<env>
        #       ADH_<Custodian>_Gen_SPN_<env>-Secret
        # ---------------------------------------------------
        $genSpnBaseName = "ADH_{0}_Gen_SPN_{1}" -f $Custodian, $env

        try {
            $genSpnIdSecret = Get-AzKeyVaultSecret -VaultName $keyVaultNameCust -Name $genSpnBaseName -ErrorAction Stop
            $DbSpnClientId  = $genSpnIdSecret.SecretValueText
            Write-Host "INFO: Retrieved Gen_SPN ClientId from '$keyVaultNameCust' ($env) name '$genSpnBaseName'" -ForegroundColor Cyan
        } catch {
            Write-Warning "Failed to retrieve Gen_SPN ClientId '$genSpnBaseName' from '$keyVaultNameCust' ($env): $_"
        }

        try {
            $genSpnSecretName = $genSpnBaseName + "-Secret"
            $genSpnSecret = Get-AzKeyVaultSecret -VaultName $keyVaultNameCust -Name $genSpnSecretName -ErrorAction Stop
            $DbSpnClientSecret = $genSpnSecret.SecretValueText
            Write-Host ("INFO: Retrieved Gen_SPN ClientSecret from '{0}' ({1}) name '{2}' (len={3})" -f $keyVaultNameCust, $env, $genSpnSecretName, $DbSpnClientSecret.Length) -ForegroundColor Cyan
        } catch {
            Write-Warning "Failed to retrieve Gen_SPN ClientSecret '$genSpnSecretName' from '$keyVaultNameCust' ($env): $_"
        }

        # ---------------------------------------------------
        # 1. PAT from ADH-<Custodian>-Infra-KV-<env>
        #    Secret: SPN-TOKEN-CUSTODIAN-GEN
        # ---------------------------------------------------
        $patSecretName = "SPN-TOKEN-CUSTODIAN-GEN"
        try {
            $tokenSecret   = Get-AzKeyVaultSecret -VaultName $keyVaultNameInfra -Name $patSecretName -ErrorAction Stop
            $DatabricksPat = $tokenSecret.SecretValueText
            Write-Host "INFO: Retrieved Databricks PAT from '$keyVaultNameInfra' ($env)" -ForegroundColor Cyan
        } catch {
            Write-Warning "Failed to retrieve PAT '$patSecretName' from '$keyVaultNameInfra' ($env): $_"
        }

        # ---------------------------------------------------
        # 2. Workspace URL and ID from ADH-<Custodian>-Infra-KV-<env>
        #    Support both WORKSPACE and WORKSAPCE spellings
        # ---------------------------------------------------
        $urlSecretNameTidy   = "DATABRICKS-WORKSPACE-URL"
        $urlSecretNameTypos  = "DATABRICKS-WORKSAPCE-URL"
        $idSecretNameTidy    = "DATABRICKS-WORKSPACE-ID"
        $idSecretNameTypos   = "DATABRICKS-WORKSAPCE-ID"

        # URL
        try {
            $wsUrlSecret = Get-AzKeyVaultSecret -VaultName $keyVaultNameInfra -Name $urlSecretNameTidy -ErrorAction Stop
            $workspaceUrl = $wsUrlSecret.SecretValueText
            Write-Host "DEBUG: URL from '$keyVaultNameInfra' ($env) using '$urlSecretNameTidy' -> len=$($workspaceUrl.Length) value=[$workspaceUrl]" -ForegroundColor Yellow
        } catch {
            Write-Warning "Failed to retrieve $urlSecretNameTidy from '$keyVaultNameInfra' ($env): $_"
            try {
                $wsUrlSecret = Get-AzKeyVaultSecret -VaultName $keyVaultNameInfra -Name $urlSecretNameTypos -ErrorAction Stop
                $workspaceUrl = $wsUrlSecret.SecretValueText
                Write-Host "DEBUG: URL from '$keyVaultNameInfra' ($env) using '$urlSecretNameTypos' -> len=$($workspaceUrl.Length) value=[$workspaceUrl]" -ForegroundColor Yellow
            } catch {
                Write-Warning "Failed to retrieve $urlSecretNameTypos from '$keyVaultNameInfra' ($env) as well: $_"
            }
        }

        # ID
        try {
            $wsIdSecret = Get-AzKeyVaultSecret -VaultName $keyVaultNameInfra -Name $idSecretNameTidy -ErrorAction Stop
            $workspaceId = $wsIdSecret.SecretValueText
        } catch {
            Write-Warning "Failed to retrieve $idSecretNameTidy from '$keyVaultNameInfra' ($env): $_"
            try {
                $wsIdSecret = Get-AzKeyVaultSecret -VaultName $keyVaultNameInfra -Name $idSecretNameTypos -ErrorAction Stop
                $workspaceId = $wsIdSecret.SecretValueText
            } catch {
                Write-Warning "Failed to retrieve $idSecretNameTypos from '$keyVaultNameInfra' ($env) as well: $_"
            }
        }

        $workspaceName = "ADH_${Custodian}_${env}"

        # ---------------------------------------------------
        # 3. Handle URL not found / empty
        # ---------------------------------------------------
        if ($null -eq $workspaceUrl) {
            $workspaceResults += [pscustomobject]@{
                SubscriptionName = $sub.Name
                SubscriptionId   = $sub.Id
                Env              = $env
                WorkspaceName    = $workspaceName
                WorkspaceId      = $workspaceId
                WorkspaceUrl     = ''
                State            = 'UrlSecretNotFound'
                Location         = ''
                KeyVaultNameInfra= $keyVaultNameInfra
                KeyVaultNameCust = $keyVaultNameCust
                GenSpnClientId   = $DbSpnClientId
                adh_group        = $adh_group
                adh_sub_group    = $adh_sub_group
                BranchName       = $BranchName
            }
            Write-Warning "Workspace URL secret not found for Custodian '$Custodian', env '$env' in '$keyVaultNameInfra' – skipping Databricks API calls."
            continue
        }

        if ([string]::IsNullOrWhiteSpace($workspaceUrl)) {
            $workspaceResults += [pscustomobject]@{
                SubscriptionName = $sub.Name
                SubscriptionId   = $sub.Id
                Env              = $env
                WorkspaceName    = $workspaceName
                WorkspaceId      = $workspaceId
                WorkspaceUrl     = ''
                State            = 'EmptyUrlInKeyVault'
                Location         = ''
                KeyVaultNameInfra= $keyVaultNameInfra
                KeyVaultNameCust = $keyVaultNameCust
                GenSpnClientId   = $DbSpnClientId
                adh_group        = $adh_group
                adh_sub_group    = $adh_sub_group
                BranchName       = $BranchName
            }
            Write-Warning "Workspace URL is empty/whitespace for Custodian '$Custodian', env '$env' in '$keyVaultNameInfra' – skipping Databricks API calls."
            continue
        }

        # Non-empty URL → configured, we also record Gen_SPN client ID
        $workspaceResults += [pscustomobject]@{
            SubscriptionName = $sub.Name
            SubscriptionId   = $sub.Id
            Env              = $env
            WorkspaceName    = $workspaceName
            WorkspaceId      = $workspaceId
            WorkspaceUrl     = $workspaceUrl
            State            = 'ConfiguredInKeyVault'
            Location         = ''
            KeyVaultNameInfra= $keyVaultNameInfra
            KeyVaultNameCust = $keyVaultNameCust
            GenSpnClientId   = $DbSpnClientId
            adh_group        = $adh_group
            adh_sub_group    = $adh_sub_group
            BranchName       = $BranchName
        }

        if (-not $DatabricksPat) {
            Write-Warning "No Databricks PAT available for Custodian '$Custodian', env '$env' – skipping Databricks API calls."
            continue
        }

        # ---------------------------------------------------
        # 4. Workspace Permissions
        # ---------------------------------------------------
        try {
            $perm = Get-DbWorkspacePermissions -WorkspaceUrl $workspaceUrl -DatabricksPat $DatabricksPat
            foreach ($ace in $perm.access_control_list) {
                $principalName = $ace.user_name ?? $ace.group_name ?? $ace.service_principal_name
                $principalType = if ($ace.user_name) { 'user' }
                                 elseif ($ace.group_name) { 'group' }
                                 else { 'service_principal' }
                foreach ($p in $ace.all_permissions) {
                    $workspacePermResults += [pscustomobject]@{
                        SubscriptionName = $sub.Name
                        SubscriptionId   = $sub.Id
                        Env              = $env
                        WorkspaceName    = $workspaceName
                        PrincipalType    = $principalType
                        PrincipalName    = $principalName
                        PermissionLevel  = $p.permission_level
                        Inherited        = $p.inherited
                        adh_group        = $adh_group
                        adh_sub_group    = $adh_sub_group
                    }
                }
            }
        } catch {
            Write-Warning "Failed to fetch workspace permissions for '$workspaceName': $_"
        }

        # ---------------------------------------------------
        # 5. SQL Warehouses & Permissions
        # ---------------------------------------------------
        try {
            $whs = Get-DbWarehouses -WorkspaceUrl $workspaceUrl -DatabricksPat $DatabricksPat
            foreach ($wh in $whs.warehouses) {
                $sqlWhResults += [pscustomobject]@{
                    SubscriptionName = $sub.Name
                    SubscriptionId   = $sub.Id
                    Env              = $env
                    WorkspaceName    = $workspaceName
                    WarehouseId      = $wh.id
                    WarehouseName    = $wh.name
                    ClusterSize      = $wh.cluster_size
                    State            = $wh.state
                    AutoStopMinutes  = $wh.auto_stop_mins
                    Tags             = ($wh.tags | ConvertTo-Json -Compress)
                    adh_group        = $adh_group
                    adh_sub_group    = $adh_sub_group
                }
                try {
                    $permWh = Get-DbWarehousePermissions -WorkspaceUrl $workspaceUrl -WarehouseId $wh.id -DatabricksPat $DatabricksPat
                    foreach ($ace in $permWh.access_control_list) {
                        $principalName = $ace.user_name ?? $ace.group_name ?? $ace.service_principal_name
                        $principalType = if ($ace.user_name) { 'user' }
                                         elseif ($ace.group_name) { 'group' }
                                         else { 'service_principal' }
                        foreach ($p in $ace.all_permissions) {
                            $sqlWhPermResults += [pscustomobject]@{
                                SubscriptionName = $sub.Name
                                SubscriptionId   = $sub.Id
                                Env              = $env
                                WorkspaceName    = $workspaceName
                                WarehouseId      = $wh.id
                                WarehouseName    = $wh.name
                                PrincipalType    = $principalType
                                PrincipalName    = $principalName
                                PermissionLevel  = $p.permission_level
                                Inherited        = $p.inherited
                                adh_group        = $adh_group
                                adh_sub_group    = $adh_sub_group
                            }
                        }
                    }
                } catch {
                    Write-Warning "Failed to fetch warehouse permissions for '$($wh.name)': $_"
                }
            }
        } catch {
            Write-Warning "Failed to list SQL warehouses for '$workspaceName': $_"
        }

        # ---------------------------------------------------
        # 6. Catalogs & Permissions
        # ---------------------------------------------------
        try {
            $cats = Get-DbCatalogsList -WorkspaceUrl $workspaceUrl -DatabricksPat $DatabricksPat
            foreach ($cat in $cats.catalogs) {
                $catalogListResults += [pscustomobject]@{
                    SubscriptionName = $sub.Name
                    SubscriptionId   = $sub.Id
                    Env              = $env
                    WorkspaceName    = $workspaceName
                    CatalogName      = $cat.name
                    CatalogType      = $cat.catalog_type
                    Comment          = $cat.comment
                    Properties       = ($cat.properties | ConvertTo-Json -Compress)
                    adh_group        = $adh_group
                    adh_sub_group    = $adh_sub_group
                }
                try {
                    $permCat = Get-DbCatalogPermissions -WorkspaceUrl $workspaceUrl -CatalogName $cat.name -DatabricksPat $DatabricksPat
                    foreach ($entry in $permCat.privilege_assignments) {
                        $catalogPermResults += [pscustomobject]@{
                            SubscriptionName = $sub.Name
                            SubscriptionId   = $sub.Id
                            Env              = $env
                            WorkspaceName    = $workspaceName
                            CatalogName      = $cat.name
                            PrincipalName    = $entry.principal
                            Privileges       = ($entry.privileges -join ',')
                            adh_group        = $adh_group
                            adh_sub_group    = $adh_sub_group
                        }
                    }
                } catch {
                    Write-Warning "Failed to fetch catalog permissions for '$($cat.name)': $_"
                }
            }
        } catch {
            Write-Warning "Failed to list catalogs for '$workspaceName': $_"
        }

        # ---------------------------------------------------
        # 7. External Locations & Permissions
        # ---------------------------------------------------
        try {
            $extLocs = Get-DbExternalLocationsList -WorkspaceUrl $workspaceUrl -DatabricksPat $DatabricksPat
            foreach ($loc in $extLocs.external_locations) {
                $extLocResults += [pscustomobject]@{
                    SubscriptionName = $sub.Name
                    SubscriptionId   = $sub.Id
                    Env              = $env
                    WorkspaceName    = $workspaceName
                    ExternalLocation = $loc.name
                    Url              = $loc.url
                    CredentialName   = $loc.credential_name
                    Comment          = $loc.comment
                    adh_group        = $adh_group
                    adh_sub_group    = $adh_sub_group
                }
                try {
                    $permLoc = Get-DbExternalLocationPermissions -WorkspaceUrl $workspaceUrl -Name $loc.name -DatabricksPat $DatabricksPat
                    foreach ($entry in $permLoc.privilege_assignments) {
                        $extLocPermResults += [pscustomobject]@{
                            SubscriptionName  = $sub.Name
                            SubscriptionId    = $sub.Id
                            Env               = $env
                            WorkspaceName     = $workspaceName
                            ExternalLocation  = $loc.name
                            PrincipalName     = $entry.principal
                            Privileges        = ($entry.privileges -join ',')
                            adh_group         = $adh_group
                            adh_sub_group     = $adh_sub_group
                        }
                    }
                } catch {
                    Write-Warning "Failed to fetch external location permissions for '$($loc.name)': $_"
                }
            }
        } catch {
            Write-Warning "Failed to list external locations for '$workspaceName': $_"
        }
    }
}

# -------------------------------------------------------
# Export Data (no '*' in filenames)
# -------------------------------------------------------
$csvWs       = $null
$csvWsPerm   = $null
$csvWh       = $null
$csvWhPerm   = $null
$csvCatList  = $null
$csvCatPerm  = $null
$csvExt      = $null
$csvExtPerm  = $null

if ($workspaceResults.Count -gt 0) {
    $csvWs = New-StampedPath -BaseDir $OutputDir -Prefix ("db_ws_{0}_{1}" -f $adh_group, $adh_subscription_type)
    Write-CsvSafe -Rows $workspaceResults -Path $csvWs
    Convert-CsvToHtml -CsvPath $csvWs -HtmlPath ($csvWs -replace '.csv$', '.html') -Title "Databricks Workspaces ($adh_group / $adh_subscription_type) $BranchName"
} else {
    Write-Warning "No workspace results collected – skipping workspace CSV export."
}

if ($workspacePermResults.Count -gt 0) {
    $csvWsPerm = New-StampedPath -BaseDir $OutputDir -Prefix ("db_ws_perms_{0}_{1}" -f $adh_group, $adh_subscription_type)
    Write-CsvSafe -Rows $workspacePermResults -Path $csvWsPerm
}

if ($sqlWhResults.Count -gt 0) {
    $csvWh = New-StampedPath -BaseDir $OutputDir -Prefix ("db_sqlwh_{0}_{1}" -f $adh_group, $adh_subscription_type)
    Write-CsvSafe -Rows $sqlWhResults -Path $csvWh
}

if ($sqlWhPermResults.Count -gt 0) {
    $csvWhPerm = New-StampedPath -BaseDir $OutputDir -Prefix ("db_sqlwh_perms_{0}_{1}" -f $adh_group, $adh_subscription_type)
    Write-CsvSafe -Rows $sqlWhPermResults -Path $csvWhPerm
}

if ($catalogListResults.Count -gt 0) {
    $csvCatList = New-StampedPath -BaseDir $OutputDir -Prefix ("db_catalogs_{0}_{1}" -f $adh_group, $adh_subscription_type)
    Write-CsvSafe -Rows $catalogListResults -Path $csvCatList
}

if ($catalogPermResults.Count -gt 0) {
    $csvCatPerm = New-StampedPath -BaseDir $OutputDir -Prefix ("db_catalog_perms_{0}_{1}" -f $adh_group, $adh_subscription_type)
    Write-CsvSafe -Rows $catalogPermResults -Path $csvCatPerm
}

if ($extLocResults.Count -gt 0) {
    $csvExt = New-StampedPath -BaseDir $OutputDir -Prefix ("db_extloc_{0}_{1}" -f $adh_group, $adh_subscription_type)
    Write-CsvSafe -Rows $extLocResults -Path $csvExt
}

if ($extLocPermResults.Count -gt 0) {
    $csvExtPerm = New-StampedPath -BaseDir $OutputDir -Prefix ("db_extloc_perms_{0}_{1}" -f $adh_group, $adh_subscription_type)
    Write-CsvSafe -Rows $extLocPermResults -Path $csvExtPerm
}

Write-Host "Databricks inventory scan completed." -ForegroundColor Green

if ($csvWs)      { Write-Host "Workspace CSV           : $csvWs" }
if ($csvWsPerm)  { Write-Host "Workspace perms CSV     : $csvWsPerm" }
if ($csvWh)      { Write-Host "SQL Warehouses CSV      : $csvWh" }
if ($csvWhPerm)  { Write-Host "SQL Warehouse perms CSV : $csvWhPerm" }
if ($csvCatList) { Write-Host "Catalog list CSV        : $csvCatList" }
if ($csvCatPerm) { Write-Host "Catalog perms CSV       : $csvCatPerm" }
if ($csvExt)     { Write-Host "External locations CSV  : $csvExt" }
if ($csvExtPerm) { Write-Host "Ext loc perms CSV       : $csvExtPerm" }
