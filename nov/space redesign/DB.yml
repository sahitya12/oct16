# sanitychecks/pipelines/databricks.yml

parameters:
  - name: adh_group
    type: string
    default: ''
  - name: adh_sub_group
    type: string
    default: ''
  - name: adh_subscription_type
    type: string
    default: nonprd
    values:
      - nonprd
      - prd
  - name: poolName
    type: string
    default: 'Self-Hosted-Pool'
  - name: agentName
    type: string
    default: ''
  - name: variableGroup
    type: string
    default: 'modernization_tfstate_backend_details'
  - name: outputDir
    type: string
    default: '$(Build.SourcesDirectory)/sanitychecks/output'

stages:
- stage: databricks_scan
  displayName: "Databricks Scan (${{ parameters.adh_group }} / ${{ parameters.adh_subscription_type }})"
  condition: and(succeeded(), ne('${{ parameters.adh_group }}',''))

  jobs:
  - template: ../templates/job.powershell-with-az.yml
    parameters:
      displayName: 'Databricks Scan'
      poolName: ${{ parameters.poolName }}
      agentName: ${{ parameters.agentName }}
      variableGroup: ${{ parameters.variableGroup }}
      scriptPath: '$(Build.SourcesDirectory)/sanitychecks/scripts/Scan-Databricks.ps1'
      workingDir: '$(Build.SourcesDirectory)/sanitychecks/scripts'
      arguments: >-
        -TenantId "$(tenant_id)"
        -ClientId "$(backend_client_id)"
        -ClientSecret "$(backend_client_secret)"
        -adh_group "${{ parameters.adh_group }}"
        -adh_sub_group "${{ parameters.adh_sub_group }}"
        -adh_subscription_type "${{ parameters.adh_subscription_type }}"
        -OutputDir "${{ parameters.outputDir }}"
        -BranchName "$(Build.SourceBranchName)"
