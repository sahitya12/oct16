trigger: none
pr: none

parameters:
- name: adh_group
  type: string
  default: ''
- name: adh_subscription_type
  type: string
  default: nonprd
  values: [nonprd, prd]
- name: poolSuffix
  type: string
  default: '_agent1'
  values: ['_agent1','_agent2']
- name: poolName
  type: string
  default: 'Self-Hosted-Pool'

# compute the exact self-hosted agent display name
variables:
- name: agentName
  value: ${{ format('{0}_{1}{2}', parameters.adh_group, parameters.adh_subscription_type, parameters.poolSuffix) }}

stages:
# ---------------- RG Permissions ----------------
- template: stages/rg_permissions.stage.yml
  parameters:
    adh_group:             ${{ parameters.adh_group }}
    adh_subscription_type: ${{ parameters.adh_subscription_type }}
    poolName:              ${{ parameters.poolName }}
    agentName:             ${{ variables.agentName }}

# ---------------- RG Tags ----------------
- template: stages/rg_tags.stage.yml
  parameters:
    adh_group:             ${{ parameters.adh_group }}
    adh_subscription_type: ${{ parameters.adh_subscription_type }}
    poolName:              ${{ parameters.poolName }}
    agentName:             ${{ variables.agentName }}

# ---------------- KV Secrets ----------------
- template: stages/kv_secrets.stage.yml
  parameters:
    adh_group:             ${{ parameters.adh_group }}
    adh_subscription_type: ${{ parameters.adh_subscription_type }}
    poolName:              ${{ parameters.poolName }}
    agentName:             ${{ variables.agentName }}

# ---------------- KV Permissions ----------------
- template: stages/kv_permissions.stage.yml
  parameters:
    adh_group:             ${{ parameters.adh_group }}
    adh_subscription_type: ${{ parameters.adh_subscription_type }}
    poolName:              ${{ parameters.poolName }}
    agentName:             ${{ variables.agentName }}

# ---------------- KV Firewall ----------------
- template: stages/kv_firewall.stage.yml
  parameters:
    adh_group:             ${{ parameters.adh_group }}
    adh_subscription_type: ${{ parameters.adh_subscription_type }}
    poolName:              ${{ parameters.poolName }}
    agentName:             ${{ variables.agentName }}

# ---------------- VNet & Peerings ----------------
- template: stages/vnet.stage.yml
  parameters:
    adh_group:             ${{ parameters.adh_group }}
    adh_subscription_type: ${{ parameters.adh_subscription_type }}
    poolName:              ${{ parameters.poolName }}
    agentName:             ${{ variables.agentName }}

# ---------------- ADF ----------------
- template: stages/adf.stage.yml
  parameters:
    adh_group:             ${{ parameters.adh_group }}
    adh_subscription_type: ${{ parameters.adh_subscription_type }}
    poolName:              ${{ parameters.poolName }}
    agentName:             ${{ variables.agentName }}

# ---------------- ADLS Validation ----------------
- template: stages/adls.stage.yml
  parameters:
    adh_group:             ${{ parameters.adh_group }}
    adh_subscription_type: ${{ parameters.adh_subscription_type }}
    poolName:              ${{ parameters.poolName }}
    agentName:             ${{ variables.agentName }}
