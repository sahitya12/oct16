trigger: none
pr: none

parameters:
  # -------------------------
  # Core inputs
  # -------------------------
  - name: adh_group
    type: string
    default: ''

  # OPTIONAL – can be left blank when not used (KTK only, etc.)
  # Default is a single space so the UI doesn't block the Run button,
  # but we normalize it to '' in variables.
  - name: adh_sub_group
    type: string
    default: ' '

  - name: adh_subscription_type
    type: string
    default: nonprd
    values:
      - nonprd
      - prd

  - name: poolSuffix
    type: string
    default: '_agent1'
    values:
      - '_agent1'
      - '_agent2'
      - '_agent3'

  - name: poolName
    type: string
    default: 'Self-Hosted-Pool'

  # ✅ NEW: Optional custom agent override
  - name: custom_agent_name
    type: string
    default: ''

  # -------------------------
  # Stage toggles
  # -------------------------
  - name: run_all_stages
    type: boolean
    default: true

  - name: run_rg_permissions
    type: boolean
    default: false

  - name: run_rg_tags
    type: boolean
    default: false

  - name: run_kv_secrets
    type: boolean
    default: false

  - name: run_kv_permissions
    type: boolean
    default: false

  - name: run_kv_firewall
    type: boolean
    default: false

  - name: run_vnet
    type: boolean
    default: false

  - name: run_adf
    type: boolean
    default: false

  - name: run_adls
    type: boolean
    default: false

  - name: run_databricks
    type: boolean
    default: false


variables:
  # Normalize adh_sub_group: remove all spaces so " " becomes ""
  - name: adh_sub_group_normalized
    value: ${{ replace(parameters.adh_sub_group, ' ', '') }}

  # ✅ UPDATED: Agent name resolution with override support
  # Remains compile-time safe for demands
  - name: agentName
    value: ${{ 
      if ne(parameters.custom_agent_name, '') 
      then parameters.custom_agent_name 
      else format('{0}_{1}{2}', parameters.adh_group, parameters.adh_subscription_type, parameters.poolSuffix) 
    }}


stages:
  # -------------------------------------------------------
  # 0. Az context cleanup
  # -------------------------------------------------------
  - stage: az_context_cleanup
    displayName: "Az context cleanup on agent"
    condition: and(succeeded(), ne('${{ parameters.adh_group }}',''))
    jobs:
      - job: cleanup_az_context
        displayName: "Cleanup Az contexts and defaults"
        pool:
          name: ${{ parameters.poolName }}
          demands:
            - Agent.Name -equals ${{ variables.agentName }}

        steps:
          - checkout: self

          - task: PowerShell@2
            displayName: "Reset Az context and default subscription"
            inputs:
              targetType: inline
              pwsh: true
              script: |
                Write-Host "=== Az context cleanup start ==="
                Write-Host "Using agent: $env:AGENT_NAME"

                Import-Module Az.Accounts -ErrorAction Stop

                Disable-AzContextAutosave -Scope Process | Out-Null
                Clear-AzContext -Scope Process -Force -ErrorAction SilentlyContinue | Out-Null

                $cfg = Get-AzConfig | Where-Object Name -like '*DefaultSubscriptionForLogin*'
                if ($cfg) {
                  Update-AzConfig -DefaultSubscriptionForLogin '' | Out-Null
                }

                foreach ($k in @(
                  'AZURE_SUBSCRIPTION_ID',
                  'ARM_SUBSCRIPTION_ID',
                  'AZURE_SUBSCRIPTION',
                  'ARM_SUBSCRIPTION'
                )) {
                  if (Test-Path "env:$k") {
                    Remove-Item "env:$k" -ErrorAction SilentlyContinue
                  }
                }

                Write-Host "=== Az context cleanup done ==="


  # -------------------------------------------------------
  # 1. Agent diagnostics
  # -------------------------------------------------------
  - stage: agent_injection_check
    displayName: "Agent Parameter Injection and Diagnostics"
    condition: and(succeeded(), ne('${{ parameters.adh_group }}',''))
    jobs:
      - job: test_param_injection
        displayName: "PowerShell Parameter and Environment Check"
        pool:
          name: ${{ parameters.poolName }}
          demands:
            - Agent.Name -equals ${{ variables.agentName }}

        steps:
          - checkout: self

          - task: PowerShell@2
            displayName: "Confirm selected agent"
            inputs:
              targetType: inline
              pwsh: true
              script: |
                Write-Host "Pipeline is running on agent: $(agentName)"

          - task: PowerShell@2
            displayName: "List Environment Variables"
            inputs:
              targetType: inline
              pwsh: true
              script: |
                Get-ChildItem Env: | Sort-Object Name | Format-Table -AutoSize


  # -------------------------------------------------------
  # 2. RG Permissions
  # -------------------------------------------------------
  - ${{ if or(eq(parameters.run_all_stages, true), eq(parameters.run_rg_permissions, true)) }}:
    - template: stages/rg_permissions.stage.yml
      parameters:
        adh_group:             ${{ parameters.adh_group }}
        adh_sub_group:         ${{ variables.adh_sub_group_normalized }}
        adh_subscription_type: ${{ parameters.adh_subscription_type }}
        poolName:              ${{ parameters.poolName }}
        agentName:             ${{ variables.agentName }}

  # -------------------------------------------------------
  # 3. RG Tags
  # -------------------------------------------------------
  - ${{ if or(eq(parameters.run_all_stages, true), eq(parameters.run_rg_tags, true)) }}:
    - template: stages/rg_tags.stage.yml
      parameters:
        adh_group:             ${{ parameters.adh_group }}
        adh_sub_group:         ${{ variables.adh_sub_group_normalized }}
        adh_subscription_type: ${{ parameters.adh_subscription_type }}
        poolName:              ${{ parameters.poolName }}
        agentName:             ${{ variables.agentName }}

  # -------------------------------------------------------
  # 4. Key Vault Secrets
  # -------------------------------------------------------
  - ${{ if or(eq(parameters.run_all_stages, true), eq(parameters.run_kv_secrets, true)) }}:
    - template: stages/kv_secrets.stage.yml
      parameters:
        adh_group:             ${{ parameters.adh_group }}
        adh_sub_group:         ${{ variables.adh_sub_group_normalized }}
        adh_subscription_type: ${{ parameters.adh_subscription_type }}
        poolName:              ${{ parameters.poolName }}
        agentName:             ${{ variables.agentName }}

  # -------------------------------------------------------
  # 5. Key Vault Permissions
  # -------------------------------------------------------
  - ${{ if or(eq(parameters.run_all_stages, true), eq(parameters.run_kv_permissions, true)) }}:
    - template: stages/kv_permissions.stage.yml
      parameters:
        adh_group:             ${{ parameters.adh_group }}
        adh_sub_group:         ${{ variables.adh_sub_group_normalized }}
        adh_subscription_type: ${{ parameters.adh_subscription_type }}
        poolName:              ${{ parameters.poolName }}
        agentName:             ${{ variables.agentName }}

  # -------------------------------------------------------
  # 6. Key Vault Firewall
  # -------------------------------------------------------
  - ${{ if or(eq(parameters.run_all_stages, true), eq(parameters.run_kv_firewall, true)) }}:
    - template: stages/kv_firewall.stage.yml
      parameters:
        adh_group:             ${{ parameters.adh_group }}
        adh_sub_group:         ${{ variables.adh_sub_group_normalized }}
        adh_subscription_type: ${{ parameters.adh_subscription_type }}
        poolName:              ${{ parameters.poolName }}
        agentName:             ${{ variables.agentName }}

  # -------------------------------------------------------
  # 7. VNet / Network
  # -------------------------------------------------------
  - ${{ if or(eq(parameters.run_all_stages, true), eq(parameters.run_vnet, true)) }}:
    - template: stages/vnet.stage.yml
      parameters:
        adh_group:             ${{ parameters.adh_group }}
        adh_subscription_type: ${{ parameters.adh_subscription_type }}
        poolName:              ${{ parameters.poolName }}
        agentName:             ${{ variables.agentName }}

  # -------------------------------------------------------
  # 8. Data Factory
  # -------------------------------------------------------
  - ${{ if or(eq(parameters.run_all_stages, true), eq(parameters.run_adf, true)) }}:
    - template: stages/adf.stage.yml
      parameters:
        adh_group:             ${{ parameters.adh_group }}
        adh_subscription_type: ${{ parameters.adh_subscription_type }}
        poolName:              ${{ parameters.poolName }}
        agentName:             ${{ variables.agentName }}

  # -------------------------------------------------------
  # 9. ADLS Validation
  # -------------------------------------------------------
  - ${{ if or(eq(parameters.run_all_stages, true), eq(parameters.run_adls, true)) }}:
    - template: stages/adls.stage.yml
      parameters:
        adh_group:             ${{ parameters.adh_group }}
        adh_sub_group:         ${{ variables.adh_sub_group_normalized }}
        adh_subscription_type: ${{ parameters.adh_subscription_type }}
        poolName:              ${{ parameters.poolName }}
        agentName:             ${{ variables.agentName }}

  # -------------------------------------------------------
  # 10. Databricks Scan
  # -------------------------------------------------------
  - ${{ if or(eq(parameters.run_all_stages, true), eq(parameters.run_databricks, true)) }}:
    - template: stages/databricks.stage.yml
      parameters:
        adh_group:             ${{ parameters.adh_group }}
        adh_subscription_type: ${{ parameters.adh_subscription_type }}
        poolName:              ${{ parameters.poolName }}
        agentName:             ${{ variables.agentName }}
