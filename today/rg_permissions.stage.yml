parameters:
  variableGroup: 'modernization_tfstate_backend_details'
  adh_group: ''
  adh_subscription_type: 'nonprd'
  poolType: 'self'
  poolName: ''
  poolSuffix: '_agent1'

jobs:
- template: ../templates/job.powershell-with-az.yml
  parameters:
    variableGroup: ${{ parameters.variableGroup }}
    displayName: 'RG Permissions Scan'
    scriptPath: 'sanitychecks/scripts/Scan-RG-Permissions-ByCustodian.ps1'
    workingDir: '$(Build.SourcesDirectory)/sanitychecks/scripts'
    arguments: >-
      -TenantId '$(tenant_id)'
      -ClientId '$(backend_client_id)'
      -ClientSecret '$(backend_client_secret)'
      -adh_group '${{ parameters.adh_group }}'
      -adh_subscription_type '${{ parameters.adh_subscription_type }}'
      -OutputDir '$(Build.ArtifactStagingDirectory)/rg-permissions'
      -BranchName '$(Build.SourceBranchName)'
      -ProdCsvPath '$(Build.SourcesDirectory)/sanitychecks/inputs/prod_permissions.csv'
      -NonProdCsvPath '$(Build.SourcesDirectory)/sanitychecks/inputs/nonprod_permissions.csv'
    artifactName: "rg-permissions"
    publishPath: "$(Build.ArtifactStagingDirectory)/rg-permissions"
    poolType: ${{ parameters.poolType }}
    poolName: ${{ parameters.poolName }}
    poolSuffix: ${{ parameters.poolSuffix }}
    adh_group: ${{ parameters.adh_group }}
    adh_subscription_type: ${{ parameters.adh_subscription_type }}
