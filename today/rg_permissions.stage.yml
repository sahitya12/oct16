# sanitychecks/.azure-pipelines/stages/rg_permissions.stage.yml
parameters:
  - name: adh_group
    type: string
    default: ''
  - name: adh_subscription_type
    type: string
    default: nonprd
    values: [nonprd, prd]
  - name: poolName
    type: string
    default: 'Self-Hosted-Pool'
  - name: agentName
    type: string
    default: ''

stages:
- stage: rg_permissions
  displayName: "RG Permissions (ByCustodian)"
  condition: and(succeeded(), ne('${{ parameters.adh_group }}',''))

  variables:
  - group: modernization_tfstate_backend_details   # <-- ensure THIS is your group name

  jobs:
  - job: scan_rg_permissions
    displayName: "Scan RG Permissions: ${{ parameters.adh_group }} (${{ parameters.adh_subscription_type }})"
    pool:
      name: ${{ parameters.poolName }}
      demands:
      - Agent.Name -equals ${{ parameters.agentName }}

    steps:
    - checkout: self
      clean: true

    # sanity check the secret variables are actually present (without printing them)
    - task: PowerShell@2
      displayName: "Validate RG Permissions inputs"
      inputs:
        targetType: inline
        pwsh: true
        script: |
          if ([string]::IsNullOrWhiteSpace('$(tenant_id)')) { throw "tenant_id is missing (add variable group or variable)" }
          if ([string]::IsNullOrWhiteSpace('$(backend_client_id)')) { throw "backend_client_id is missing" }
          if ([string]::IsNullOrWhiteSpace('$(backend_client_secret)')) { throw "backend_client_secret is missing" }
          Write-Host "Inputs look OK."

    - task: PowerShell@2
      displayName: "Run RG Permissions Scan"
      inputs:
        targetType: filePath
        filePath: "$(Build.SourcesDirectory)/sanitychecks/scripts/Scan-RG-Permissions-ByCustodian.ps1"
        arguments: >
          -TenantId '$(tenant_id)'
          -ClientId '$(backend_client_id)'
          -ClientSecret '$(backend_client_secret)'
          -adh_group '${{ parameters.adh_group }}'
          -adh_subscription_type '${{ parameters.adh_subscription_type }}'
          -ProdCsvPath '$(Build.SourcesDirectory)/sanitychecks/inputs/prod_permissions.csv'
          -NonProdCsvPath '$(Build.SourcesDirectory)/sanitychecks/inputs/nonprod_permissions.csv'
          -OutputDir '$(Build.ArtifactStagingDirectory)/rg-permissions'
          -BranchName '$(Build.SourceBranchName)'
        pwsh: true

    - task: PublishBuildArtifacts@1
      displayName: "Publish RG Permissions"
      inputs:
        PathtoPublish: "$(Build.ArtifactStagingDirectory)/rg-permissions"
        ArtifactName: "rg-permissions"
