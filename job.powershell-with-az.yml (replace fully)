# ==========================================
# Template: job.powershell-with-az.yml
# Purpose : Run a PowerShell script in a given pool
#           with proper authentication & artifact publishing
# ==========================================

parameters:
  variableGroup: ''
  displayName: ''
  scriptPath: ''
  workingDir: ''
  arguments: ''
  artifactName: ''
  publishPath: ''

  poolType: 'self'             # 'hosted' | 'self'
  poolName: ''                 # optional explicit name
  poolSuffix: '_agent1'        # _agent1 | _agent2
  adh_group: ''                # for default pool name
  adh_subscription_type: ''    # prd | nonprd
  agentName: ''                # optional agent demand

jobs:
- job: run_powershell
  displayName: ${{ parameters.displayName }}

  # =======================
  # Agent Pool Selection
  # =======================
  ${{ if eq(parameters.poolType, 'hosted') }}:
    pool:
      vmImage: 'windows-latest'

  ${{ if ne(parameters.poolType, 'hosted') }}:
    pool:
      ${{ if ne(parameters.poolName, '') }}:
        name: ${{ parameters.poolName }}
      ${{ if eq(parameters.poolName, '') }}:
        name: 'Self-Hosted-Pool'
      demands:
        ${{ if ne(parameters.agentName, '') }}:
          - AgentName -equals ${{ parameters.agentName }}

  variables:
  - group: ${{ parameters.variableGroup }}

  steps:
  # =======================
  # Checkout Repo
  # =======================
  - checkout: self

  # =======================
  # Prepare Output Folder
  # =======================
  - task: PowerShell@2
    displayName: Prepare output folder
    inputs:
      targetType: inline
      pwsh: true
      script: |
        $ErrorActionPreference = 'Stop'
        $out = "${{ parameters.publishPath }}"
        if ([string]::IsNullOrWhiteSpace($out)) {
          throw "publishPath parameter is empty."
        }

        if (-not (Test-Path -LiteralPath $out)) {
          Write-Host "Creating output directory: $out"
          New-Item -ItemType Directory -Path $out -Force | Out-Null
        } else {
          Write-Host "Output directory already exists: $out"
        }

  # =======================
  # Run PowerShell Script
  # =======================
  - task: PowerShell@2
    displayName: Run ${{ parameters.scriptPath }}
    inputs:
      targetType: filePath
      filePath: ${{ parameters.scriptPath }}
      workingDirectory: ${{ parameters.workingDir }}
      arguments: ${{ parameters.arguments }}
      pwsh: true

  # =======================
  # List Output Folder
  # =======================
  - task: PowerShell@2
    displayName: List publish dir
    inputs:
      targetType: inline
      pwsh: true
      script: |
        $ErrorActionPreference = 'Stop'
        $out = "${{ parameters.publishPath }}"

        if ([string]::IsNullOrWhiteSpace($out)) {
          throw "publishPath parameter is empty."
        }

        if (Test-Path -LiteralPath $out) {
          Write-Host "Contents of: $out"
          Get-ChildItem -Recurse -Force -LiteralPath $out |
            Select-Object FullName, Length, LastWriteTime |
            Format-Table -AutoSize
        }
        else {
          Write-Warning "Publish path missing: $out (creating it and dropping a README)"
          New-Item -ItemType Directory -Path $out -Force | Out-Null
          Set-Content -Path (Join-Path $out 'README.txt') -Value 'No output files were produced.'
        }

  # =======================
  # Publish Artifact
  # =======================
  - task: PublishBuildArtifacts@1
    displayName: Publish artifact
    inputs:
      PathtoPublish: ${{ parameters.publishPath }}
      ArtifactName: ${{ parameters.artifactName }}
      publishLocation: 'Container'
